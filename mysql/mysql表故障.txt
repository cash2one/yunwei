

修复表

如果你要通过命令行来修复表，必须首先停止mysqld服务器。请注意当你在远程服务器上运行mysqladmin shutdown时，mysqladmin返回
后，mysqld服务器将仍然运行一会儿，直到停止所有查询并将所有键清空到硬盘上


阶段1 ：检查你的表
如果你有很多时间，运行myisamchk *.MYI 或myisamchk -e *.MYI。使用-s （沉默）选项禁止不必要的信息。
如果mysqld服务器处于宕机状态，应使用--update-state选项来告诉myisamchk将表标记为' 检查过的' 。
你必须只修复那些myisamchk报告有错误的表。对这样的表，继续到阶段2 。
如果在检查时，你得到奇怪的错误( 例如out of memory 错误) ，或如果myisamchk崩溃，到阶段3 。




阶段2 ：简单安全的修复
注释：如果想更快地进行修复，当运行myisamchk时，你应将sort_buffer_size和Key_buffer_size 变量的值设置为可用内存的大约25%。
首先，试试myisamchk -r -q tbl_name( -r -q 意味着“ 快速恢复模式” ) 。这将试图不接触数据文件来修复索引文件。如果数据文件包含它应有的一切内容和指
向数据文件内正确地点的删除连接，这应该管用并且表可被修复。开始修复下一张表。否则，执行下列过程：
1 .  在继续前对数据文件进行备份。
2 .  使用myisamchk -r tbl_name( -r 意味着“ 恢复模式” ) 。这将从数据文件中删除不正确的记录和已被删除的记录并重建索引文件。
3 .  如果前面的步骤失败，使用myisamchk --safe-recover tbl_name。安全恢复模式使用一个老的恢复方法，处理常规恢复模式不行的少数情况( 但是更
慢) 。




阶段3 ：困难的修复
只有在索引文件的第一个16K 块被破坏，或包含不正确的信息，或如果索引文件丢失，你才应该到这个阶段。在这种情况下，需要创建一个新的索引文件。按
如下步骤操做：
1 .  把数据文件移到安全的地方。
2 .  使用表描述文件创建新的( 空) 数据文件和索引文件：
3 .  shell> mysql db_name
4 .  mysql> SET AUTOCOMMIT=1;
5 .  mysql> TRUNCATE TABLE tbl_name;
6 .  mysql> quit
如果你的MySQL版本没有TRUNCATE TABLE，则使用DELETE FROM  tbl_name。
7 .  将老的数据文件拷贝到新创建的数据文件之中。（不要只是将老文件移回新文件之中；你要保留一个副本以防某些东西出错。）
回到阶段2 。现在myisamchk -r -q应该工作了。（这不应该是一个无限循环）。
你还可以使用REPAIR TABLE  tbl_name USE_FRM ，将自动执行整个程序。
阶段4 ：非常困难的修复
只有.frm 描述文件也破坏了，你才应该到达这个阶段。这应该从未发生过，因为在表被创建以后，描述文件就不再改变了。
1 .  从一个备份恢复描述文件然后回到阶段3 。你也可以恢复索引文件然后回到阶段2 。对后者，你应该用myisamchk -r启动。
2 .  如果你没有进行备份但是确切地知道表是怎样创建的，在另一个数据库中创建表的一个拷贝。删除新的数据文件，然后从其他数据库将描述文件和索引
文件移到破坏的数据库中。这样提供了新的描述和索引文件，但是让.MYD 数据文件独自留下来了。回到阶段2 并且尝试重建索引文件